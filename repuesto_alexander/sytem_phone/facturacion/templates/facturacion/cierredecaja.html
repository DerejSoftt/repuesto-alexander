{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cierre de Caja</title>
    <link rel="shortcut icon" href="{% static 'image/logom5.jpeg' %}" type="image/x-icon">
    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .sidebar-menu {
            padding: 20px 0;
            flex: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            position: relative;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: rgba(255, 255, 255, 0.8);
            padding-left: 30px;
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left-color: white;
        }

        .menu-item i {
            font-size: 1.3rem;
            margin-right: 15px;
            width: 25px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .menu-item:hover i,
        .menu-item.active i {
            opacity: 1;
        }

        .menu-item span {
            font-size: 1rem;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .menu-toggle:hover {
            background: #ee5a24;
            transform: scale(1.05);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            padding: 20px;
            transition: margin-left 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content-container {
            padding: 40px;
        }

        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e8ed;
        }

        .card-header h2 {
            font-size: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Summary Styles */
        .summary-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .summary-item h3 {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-item p {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control[readonly] {
            background-color: #ecf0f1;
            cursor: not-allowed;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Button Container */
        .btn-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        /* Button Styles */
        .btn-close-register {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            min-width: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-close-register:hover {
            background: linear-gradient(135deg, #5a6fd1 0%, #6741a1 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
            text-decoration: none;
            color: white;
        }

        .btn-close-register i {
            margin-right: 8px;
            font-size: 1.2rem;
        }

        /* Status Styles */
        .status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .status-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .status-warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: #f39c12;
        }

        .status-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* Alertas personalizadas */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        .custom-alert.active {
            opacity: 1;
            pointer-events: auto;
        }

        .custom-alert-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-alert-header i {
            font-size: 1.5rem;
        }

        .custom-alert-body {
            padding: 25px;
            color: #555;
            line-height: 1.6;
        }

        .custom-alert-footer {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #eee;
        }

        .custom-alert-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .custom-alert-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .custom-alert-btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd1 0%, #6741a1 100%);
            transform: translateY(-2px);
        }

        .custom-alert-btn-secondary {
            background: #f8f9fa;
            color: #555;
            border: 1px solid #ddd;
        }

        .custom-alert-btn-secondary:hover {
            background: #e9ecef;
        }

        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1099;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .custom-alert-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Auto Close Warning */
        .auto-close-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
        }

        .auto-close-warning i {
            font-size: 1.5rem;
        }

        .auto-close-critical {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 1s infinite;
        }

        .auto-close-critical i {
            font-size: 1.5rem;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .content-container {
                padding: 20px;
            }

            .card {
                padding: 20px;
            }

            .btn-close-register {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Desktop specific styles */
        @media (min-width: 769px) {
            .sidebar {
                position: fixed;
                transform: translateX(0);
                height: 100vh;
            }

            .main-content {
                margin-left: 280px;
                min-height: 100vh;
            }

            .menu-toggle {
                display: none;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 100%;
                max-width: 300px;
                height: 100vh;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 10px;
                min-height: 100vh;
            }

            .menu-toggle {
                display: block;
            }

            body.sidebar-open {
                overflow: hidden;
            }
        }

        /* Scrollbar personalizado */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Mensajes de Django */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 10px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        /* Countdown Styles */
        .countdown-timer {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .countdown-timer.active {
            display: block;
        }

        .countdown-number {
            font-size: 1.5rem;
            color: #e74c3c;
            font-weight: 800;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Menu Toggle Button -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class='bx bx-menu'></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Loading Overlay for Auto Close -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h2 id="loadingMessage">Cerrando caja automáticamente...</h2>
        <p id="loadingDetails">Redirigiendo al inicio de caja</p>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>
                <i class="fas fa-motorcycle"></i>
                Super Bestia
            </h2>
            <p>Usuario: {{ user.username }}</p>
            <p>{{ user.email }}</p>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item">
                <i class='bx bx-home-alt'></i>
                <span>Inicio</span>
            </a>
            <a href="{% url 'ventas' %}" class="menu-item">
                <i class='bx bx-receipt'></i>
                <span>Facturación</span>
            </a>
            <a href="{% url 'cotizacion' %}" class="menu-item">
                <i class='bx bx-calculator'></i>
                <span>Cotizacion</span>
            </a>
            <a href="{% url 'registrodecliente' %}" class="menu-item">
                <i class='bx bx-user-plus'></i>
                <span>Registrar Cliente</span>
            </a>
            <a href="{% url 'listadecliente' %}" class="menu-item">
                <i class='bx bx-group'></i>
                <span>Clientes</span>
            </a>
            {% if has_ventas_access or user.is_superuser %}
            <a href="{% url 'entrada' %}" class="menu-item">
                <i class='bx bx-package'></i>
                <span>Entrada Mercancía</span>
            </a>
            {% endif %}
            <a href="{% url 'cuentaporcobrar' %}" class="menu-item">
                <i class='bx bx-money'></i>
                <span>Cuenta por Cobrar</span>
            </a>
            <a href="{% url 'inventario' %}" class="menu-item active">
                <i class='bx bx-archive'></i>
                <span>Inventario</span>
            </a>
            {% if has_registrosuplidores_access or user.is_superuser %}
            <a href="{% url 'registrosuplidores' %}" class="menu-item">
                <i class='bx bx-building'></i>
                <span>Registrar Suplidores</span>
            </a>
            {% endif %}

            {% if has_gestiondesuplidores_access or user.is_superuser %}
            <a href="{% url 'gestiondesuplidores' %}" class="menu-item">
                <i class='bx bx-buildings'></i>
                <span>Suplidores</span>
            </a>
            {% endif %}
            
            {% if has_devoluciones_access or user.is_superuser %}
            <a href="{% url 'devoluciones' %}" class="menu-item">
                <i class='bx bx-undo'></i>
                <span>Devoluciones</span>
            </a>
            {% endif %}

            {% if has_roles_access or user.is_superuser %}
            <a href="{% url 'roles' %}" class="menu-item">
                <i class='bx bx-user-check'></i>
                <span>Roles</span>
            </a>
            {% endif %}
           
            {% if has_anular_access or user.is_superuser %}
            <a href="{% url 'anular' %}" class="menu-item">
                <i class='bx bx-x-circle'></i>
                <span>Anular Factura</span>
            </a>
            {% endif %}

            <a href="{% url 'reimprimirfactura' %}" class="menu-item">
                <i class='bx bx-printer'></i>
                <span>Reimprimir</span>
            </a>

            {% if has_dashboard_access or user.is_superuser %}
            <a href="{% url 'dashboard' %}" class="menu-item">
                <i class='bx bx-grid-alt'></i>
                <span>Dashboard</span>
            </a>
            {% endif %}
                
            <a href="{% url 'index' %}" class="menu-item">
                <i class='bx bx-log-out'></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
        <div class="sidebar-footer">
            <p>Derejsoft v 1.2.2</p>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>
                    <i class='bx bx-money'></i>
                    Cierre De Caja
                </h1>
                <p>Finaliza la jornada y registra los montos reales</p>
            </div>
            <div class="content-container">
                <!-- Mostrar mensajes de Django -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Contador regresivo para cierre automático -->
                <div class="countdown-timer" id="countdownTimer">
                    <i class='bx bx-time-five'></i>
                    Cierre automático en: <span class="countdown-number" id="countdownSeconds">60</span> segundos
                </div>

                <!-- Mostrar advertencia de cierre automático -->
                {% if warning_message %}
                    <div class="auto-close-warning">
                        <i class='bx bx-time'></i>
                        <div>
                            <strong>{{ warning_message }}</strong>
                            <p style="font-size: 0.9rem; margin-top: 5px;">Si no cierras manualmente, el sistema lo hará automáticamente con los montos de ventas.</p>
                        </div>
                    </div>
                {% endif %}

                <!-- Mostrar advertencia crítica si es después de las 5:30 -->
                {% if is_after_cutoff %}
                    <div class="auto-close-critical" id="autoCloseCritical">
                        <i class='bx bx-alarm-exclamation'></i>
                        <div>
                            <strong>¡ATENCIÓN! Son las {{ current_time }} - Es después de las 5:30 PM</strong>
                            <p style="font-size: 0.9rem; margin-top: 5px;">La caja se cerrará automáticamente en 10 segundos. Si deseas cerrar manualmente, hazlo ahora.</p>
                        </div>
                    </div>
                {% endif %}

                <!-- Resumen en fila horizontal -->
                <div class="summary-grid">
                    <div class="summary-item">
                        <h3><i class='bx bx-user'></i> Usuario Activo</h3>
                        <p id="current-user">{{ request.user.username }}</p>
                    </div>
                    <div class="summary-item">
                        <h3><i class='bx bx-credit-card'></i> Total Ventas</h3>
                        <p id="total-sales">RD${{ total_ventas|floatformat:2 }}</p>
                    </div>
                    <div class="summary-item">
                        <h3><i class='bx bx-money'></i> Efectivo</h3>
                        <p id="cash-sales">RD${{ ventas_efectivo|floatformat:2 }}</p>
                    </div>
                    <div class="summary-item">
                        <h3><i class='bx bx-credit-card-front'></i> Tarjeta</h3>
                        <p id="card-sales">RD${{ ventas_tarjeta|floatformat:2 }}</p>
                    </div>
                    <div class="summary-item">
                        <h3><i class='bx bx-transfer'></i> Transferencia</h3>
                        <p id="transfer-sales">RD${{ ventas_transferencia|floatformat:2 }}</p>
                    </div>
                </div>

                <!-- Grid Container con formulario -->
                <div class="grid-container">
                    <!-- Columna 1 -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class='bx bx-edit'></i> Datos de Cierre</h2>
                        </div>
                        <form id="close-register-form" method="POST" action="{% url 'procesar_cierre_caja' %}">
                            {% csrf_token %}
                            <input type="hidden" name="total_esperado" value="{{ total_ventas }}">
                            
                            <div class="form-group">
                                <label for="cash-amount" class="form-label">
                                    <i class='bx bx-money'></i> Monto en Efectivo Real
                                </label>
                                <input type="number" id="cash-amount" name="cash-amount" class="form-control" step="0.01" min="0" required>
                            </div>

                            <div class="form-group">
                                <label for="card-amount" class="form-label">
                                    <i class='bx bx-credit-card'></i> Monto en Tarjeta Real (opcional)
                                </label>
                                <input type="number" id="card-amount" name="card-amount" class="form-control" step="0.01" min="0">
                            </div>

                            <div class="form-group">
                                <label for="transfer-amount" class="form-label">
                                    <i class='bx bx-transfer'></i> Monto en Transferencia Real (opcional)
                                </label>
                                <input type="number" id="transfer-amount" name="transfer-amount" class="form-control" step="0.01" min="0">
                            </div>
                    </div>

                    <!-- Columna 2 -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class='bx bx-calculator'></i> Totales</h2>
                        </div>
                        <div class="form-group">
                            <label for="expected-total" class="form-label">
                                <i class='bx bx-calculator'></i> Total Esperado
                            </label>
                            <input type="text" id="expected-total" class="form-control" readonly value="RD${{ total_ventas|floatformat:2 }}">
                        </div>

                        <div class="form-group">
                            <label for="difference" class="form-label">
                                <i class='bx bx-transfer'></i> Diferencia (Faltante/Sobrante)
                            </label>
                            <input type="text" id="difference" class="form-control" readonly>
                            <div id="difference-status" class="status" style="display: none;">
                                <i class='bx bx-info-circle'></i> <span id="status-text"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="close-time" class="form-label">
                                <i class='bx bx-time'></i> Hora Actual
                            </label>
                            <input type="text" id="close-time" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label for="close-date" class="form-label">
                                <i class='bx bx-calendar'></i> Fecha de Cierre
                            </label>
                            <input type="text" id="close-date" class="form-control" readonly value="{{ hoy|date:'d/m/Y' }}">
                        </div>
                    </div>
                </div>

                <!-- Observaciones y Botón -->
                <div class="card">
                    <div class="form-group">
                        <label for="observations" class="form-label">
                            <i class='bx bx-note'></i> Observaciones (opcional)
                        </label>
                        <textarea id="observations" name="observations" class="form-control" placeholder="Observaciones sobre el cierre..."></textarea>
                    </div>

                    <div class="btn-container">
                        <button type="button" class="btn-close-register" id="close-register-btn" onclick="confirmClose()">
                            <i class='bx bx-check-circle'></i> Cerrar Caja Manualmente
                        </button>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alertas personalizadas -->
    <div class="custom-alert-overlay" id="customAlertOverlay"></div>
    
    <div class="custom-alert" id="customAlert">
        <div class="custom-alert-header" id="customAlertHeader">
            <i class='bx bx-info-circle'></i>
            <h3 id="customAlertTitle">Alerta</h3>
        </div>
        <div class="custom-alert-body" id="customAlertMessage">
            Mensaje de la alerta aquí
        </div>
        <div class="custom-alert-footer">
            <button class="custom-alert-btn custom-alert-btn-secondary" id="customAlertCancelBtn">Cancelar</button>
            <button class="custom-alert-btn custom-alert-btn-primary" id="customAlertConfirmBtn">Aceptar</button>
        </div>
    </div>

   <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Elementos del DOM
        const DOM = {
            form: document.getElementById("close-register-form"),
            cashAmount: document.getElementById("cash-amount"),
            cardAmount: document.getElementById("card-amount"),
            transferAmount: document.getElementById("transfer-amount"),
            expectedTotal: document.getElementById("expected-total"),
            difference: document.getElementById("difference"),
            differenceStatus: document.getElementById("difference-status"),
            statusText: document.getElementById("status-text"),
            closeDate: document.getElementById("close-date"),
            closeTime: document.getElementById("close-time"),
            observations: document.getElementById("observations"),
            currentUser: document.getElementById("current-user"),
            totalSales: document.getElementById("total-sales"),
            cashSales: document.getElementById("cash-sales"),
            cardSales: document.getElementById("card-sales"),
            transferSales: document.getElementById("transfer-sales"),
            closeRegisterBtn: document.getElementById("close-register-btn"),
            customAlert: document.getElementById("customAlert"),
            customAlertOverlay: document.getElementById("customAlertOverlay"),
            customAlertTitle: document.getElementById("customAlertTitle"),
            customAlertMessage: document.getElementById("customAlertMessage"),
            customAlertHeader: document.getElementById("customAlertHeader"),
            customAlertConfirmBtn: document.getElementById("customAlertConfirmBtn"),
            customAlertCancelBtn: document.getElementById("customAlertCancelBtn"),
            countdownTimer: document.getElementById("countdownTimer"),
            countdownSeconds: document.getElementById("countdownSeconds"),
            loadingOverlay: document.getElementById("loadingOverlay"),
            loadingMessage: document.getElementById("loadingMessage"),
            loadingDetails: document.getElementById("loadingDetails"),
            autoCloseCritical: document.getElementById("autoCloseCritical")
        };

        // Variables globales
        let isAutoCloseTime = false;
        let autoCloseCountdown = null;
        let countdownValue = 10; // 10 segundos para cierre automático
        let autoCloseInProgress = false;
        let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Funciones para el sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
            if (window.innerWidth <= 768) {
                document.body.classList.toggle('sidebar-open');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        }

        // Función para mostrar alerta personalizada
        function showAlert(title, message, type = 'info', confirmCallback = null, cancelCallback = null) {
            // Configurar el estilo según el tipo
            let headerBg = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            let icon = 'bx-info-circle';
            
            if (type === 'success') {
                headerBg = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                icon = 'bx-check-circle';
            } else if (type === 'warning') {
                headerBg = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
                icon = 'bx-error';
            } else if (type === 'error') {
                headerBg = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                icon = 'bx-x-circle';
            } else if (type === 'question') {
                headerBg = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
                icon = 'bx-question-mark';
            }
            
            DOM.customAlertHeader.style.background = headerBg;
            DOM.customAlertTitle.textContent = title;
            DOM.customAlertMessage.innerHTML = message;
            DOM.customAlertHeader.querySelector('i').className = `bx ${icon}`;
            
            // Mostrar o ocultar botón de cancelar según sea necesario
            if (cancelCallback) {
                DOM.customAlertCancelBtn.style.display = 'block';
                DOM.customAlertCancelBtn.onclick = function() {
                    hideAlert();
                    if (cancelCallback) cancelCallback();
                };
            } else {
                DOM.customAlertCancelBtn.style.display = 'none';
            }
            
            // Configurar botón de confirmación
            DOM.customAlertConfirmBtn.onclick = function() {
                hideAlert();
                if (confirmCallback) confirmCallback();
            };
            
            // Si no hay confirm callback, el botón simplemente cierra la alerta
            if (!confirmCallback) {
                DOM.customAlertConfirmBtn.onclick = function() {
                    hideAlert();
                };
            }
            
            // Mostrar alerta
            DOM.customAlertOverlay.classList.add('active');
            DOM.customAlert.classList.add('active');
        }

        // Función para ocultar alerta
        function hideAlert() {
            DOM.customAlertOverlay.classList.remove('active');
            DOM.customAlert.classList.remove('active');
        }

        // Función para mostrar overlay de carga
        function showLoading(message = 'Cerrando caja automáticamente...', details = 'Redirigiendo al inicio de caja') {
            DOM.loadingMessage.textContent = message;
            DOM.loadingDetails.textContent = details;
            DOM.loadingOverlay.classList.add('active');
        }

        // Función para ocultar overlay de carga
        function hideLoading() {
            DOM.loadingOverlay.classList.remove('active');
        }

        // Función para formatear moneda
        function formatCurrency(amount) {
            if (isNaN(amount)) amount = 0;
            return new Intl.NumberFormat('es-DO', {
                style: 'currency',
                currency: 'DOP',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount).replace('DOP', 'RD$');
        }

        // Función para formatear hora (ahora actualizable)
        function formatTime(date) {
            return date.toLocaleTimeString('es-DO', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Función para obtener la hora actual en formato 24h
        function getCurrentTime() {
            const now = new Date();
            return {
                hour: now.getHours(),
                minute: now.getMinutes(),
                second: now.getSeconds(),
                fullTime: formatTime(now)
            };
        }

        // Función para verificar si es hora de cierre automático (5:30 PM)
        function isAutoCloseTimeNow() {
            const current = getCurrentTime();
            // Verificar si es después de las 5:30 PM
            return (current.hour > 17) || (current.hour === 17 && current.minute >= 30);
        }

        // Función para actualizar la hora cada segundo
        function updateCurrentTime() {
            const now = new Date();
            DOM.closeTime.value = formatTime(now);
            
            // Verificar si es después de las 5:30 PM
            if (isAutoCloseTimeNow() && !isAutoCloseTime) {
                isAutoCloseTime = true;
                // Si es después de las 5:30 y no hay cuenta regresiva activa, iniciarla
                if (!autoCloseCountdown && !autoCloseInProgress) {
                    showAutoCloseWarning();
                }
            }
            
            // Actualizar también en el contador crítico si existe
            if (DOM.autoCloseCritical) {
                const timeElement = DOM.autoCloseCritical.querySelector('strong');
                if (timeElement) {
                    timeElement.textContent = `¡ATENCIÓN! Son las ${formatTime(now)} - Es después de las 5:30 PM`;
                }
            }
        }

        // Función para mostrar advertencia de cierre automático
        function showAutoCloseWarning() {
            const currentTime = getCurrentTime().fullTime;
            showAlert(
                'Cierre Automático Programado', 
                `Son las ${currentTime} - Es después de las 5:30 PM.<br><br>
                <strong>La caja se cerrará automáticamente en 10 segundos.</strong><br><br>
                Si deseas cerrar manualmente, haz clic en "Cerrar Caja Manualmente" ahora.`, 
                'warning',
                function() {
                    // Iniciar cuenta regresiva después de que el usuario cierre la alerta
                    setTimeout(function() {
                        startAutoCloseCountdown();
                    }, 1000);
                }
            );
        }

        // Función para calcular diferencia
        function calculateDifference() {
            // Obtener el total esperado del valor del campo (eliminando "RD$")
            const expected = parseFloat(DOM.expectedTotal.value.replace(/[^0-9.-]+/g, "")) || 0;
            const cash = parseFloat(DOM.cashAmount.value) || 0;
            const card = parseFloat(DOM.cardAmount.value) || 0;
            const transfer = parseFloat(DOM.transferAmount.value) || 0;
            const difference = (cash + card + transfer) - expected;

            DOM.difference.value = formatCurrency(Math.abs(difference));

            // Mostrar estado
            if (difference === 0) {
                DOM.differenceStatus.className = "status status-success";
                DOM.statusText.textContent = "Perfecto, no hay diferencia";
                DOM.differenceStatus.style.display = "flex";
            } else if (difference > 0) {
                DOM.differenceStatus.className = "status status-warning";
                DOM.statusText.textContent = `Sobrante de ${formatCurrency(difference)}`;
                DOM.differenceStatus.style.display = "flex";
            } else {
                DOM.differenceStatus.className = "status status-danger";
                DOM.statusText.textContent = `Faltante de ${formatCurrency(Math.abs(difference))}`;
                DOM.differenceStatus.style.display = "flex";
            }
        }

        // Función para autocompletar montos con ventas
        function autoFillWithSales() {
            // Obtener los totales de las ventas desde los elementos del resumen
            const extractNumber = (text) => {
                return parseFloat(text.replace(/[^0-9.-]+/g, "")) || 0;
            };
            
            const cashSales = extractNumber(DOM.cashSales.textContent);
            const cardSales = extractNumber(DOM.cardSales.textContent);
            const transferSales = extractNumber(DOM.transferSales.textContent);
            
            // Autocompletar los campos de entrada con los totales de ventas
            DOM.cashAmount.value = cashSales;
            DOM.cardAmount.value = cardSales;
            DOM.transferAmount.value = transferSales;
            
            // Recalcular diferencia
            calculateDifference();
            
            return { cashSales, cardSales, transferSales };
        }

        // Función para iniciar cuenta regresiva de cierre automático
        function startAutoCloseCountdown() {
            if (autoCloseInProgress) return;
            
            DOM.countdownTimer.classList.add('active');
            countdownValue = 10; // Reset a 10 segundos
            DOM.countdownSeconds.textContent = countdownValue;
            
            autoCloseCountdown = setInterval(function() {
                countdownValue--;
                DOM.countdownSeconds.textContent = countdownValue;
                
                if (countdownValue <= 3 && countdownValue > 0) {
                    DOM.countdownTimer.style.background = 'rgba(231, 76, 60, 0.2)';
                    DOM.countdownSeconds.style.color = '#e74c3c';
                }
                
                if (countdownValue <= 0) {
                    clearInterval(autoCloseCountdown);
                    autoCloseCountdown = null;
                    executeAutoClose();
                }
            }, 1000);
        }

        // Función para detener cuenta regresiva
        function stopAutoCloseCountdown() {
            if (autoCloseCountdown) {
                clearInterval(autoCloseCountdown);
                autoCloseCountdown = null;
            }
            DOM.countdownTimer.classList.remove('active');
            DOM.countdownTimer.style.background = 'rgba(231, 76, 60, 0.1)';
            DOM.countdownSeconds.style.color = '#e74c3c';
            countdownValue = 10;
        }

        // Función para enviar cierre automático vía AJAX
        function sendAutoCloseRequest() {
            return new Promise((resolve, reject) => {
                // Crear formulario para cierre automático
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken);
                formData.append('es_automatico', 'true');
                formData.append('cash-amount', DOM.cashAmount.value || '0');
                formData.append('card-amount', DOM.cardAmount.value || '0');
                formData.append('transfer-amount', DOM.transferAmount.value || '0');
                
                const now = new Date();
                const timeStr = formatTime(now);
                formData.append('observations', `Cierre automático a las ${timeStr}. Montos basados en ventas registradas.`);
                
                // Enviar petición AJAX
                fetch(DOM.form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error de red');
                    }
                    return response.json();
                })
                .then(data => {
                    resolve(data);
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        // Función para ejecutar cierre automático
        async function executeAutoClose() {
            if (autoCloseInProgress) return;
            
            autoCloseInProgress = true;
            stopAutoCloseCountdown();
            
            // Mostrar overlay de carga
            showLoading('Cerrando caja automáticamente...', 'Procesando cierre...');
            
            // Autocompletar con montos de ventas
            autoFillWithSales();
            
            try {
                // Enviar petición de cierre automático
                const result = await sendAutoCloseRequest();
                
                if (result.success) {
                    // Mostrar mensaje de éxito
                    DOM.loadingMessage.textContent = '¡Caja cerrada exitosamente!';
                    DOM.loadingDetails.textContent = 'Redirigiendo al inicio de caja...';
                    
                    // Redirigir después de 2 segundos
                    setTimeout(() => {
                        if (result.redirect_url) {
                            window.location.href = result.redirect_url;
                        } else {
                            window.location.href = '/iniciocaja/';
                        }
                    }, 2000);
                } else {
                    // Mostrar error
                    DOM.loadingMessage.textContent = 'Error al cerrar caja';
                    DOM.loadingDetails.textContent = result.message || 'Error desconocido';
                    
                    // Ocultar loading después de 3 segundos
                    setTimeout(() => {
                        hideLoading();
                        autoCloseInProgress = false;
                        showAlert('Error', result.message || 'No se pudo cerrar la caja automáticamente', 'error');
                    }, 3000);
                }
            } catch (error) {
                console.error('Error:', error);
                DOM.loadingMessage.textContent = 'Error de conexión';
                DOM.loadingDetails.textContent = 'Intenta cerrar manualmente';
                
                setTimeout(() => {
                    hideLoading();
                    autoCloseInProgress = false;
                    showAlert(
                        'Error de Conexión', 
                        'No se pudo conectar con el servidor. Intenta cerrar manualmente.', 
                        'error'
                    );
                }, 3000);
            }
        }

        // Función para confirmar cierre de caja manual
        function confirmClose() {
            // Detener cuenta regresiva si está activa
            stopAutoCloseCountdown();
            
            // Validar campos obligatorios
            if (!DOM.cashAmount.value) {
                showAlert(
                    'Datos incompletos', 
                    'Por favor ingrese el monto en efectivo para continuar con el cierre de caja.', 
                    'warning'
                );
                DOM.cashAmount.focus();
                return;
            }

            // Obtener valores actuales
            const cash = parseFloat(DOM.cashAmount.value) || 0;
            const card = parseFloat(DOM.cardAmount.value) || 0;
            const transfer = parseFloat(DOM.transferAmount.value) || 0;
            const expected = parseFloat(DOM.expectedTotal.value.replace(/[^0-9.-]+/g, "")) || 0;
            const difference = (cash + card + transfer) - expected;

            // Preparar mensaje de confirmación
            let message = `<strong>¿Está seguro que desea cerrar la caja con los siguientes datos?</strong><br><br>`;
            message += `<table style="width:100%; border-collapse: collapse; margin: 10px 0;">`;
            message += `<tr><td style="padding: 5px 0; border-bottom: 1px solid #eee;">Efectivo:</td><td style="padding: 5px 0; border-bottom: 1px solid #eee; text-align: right;"><strong>RD$${cash.toFixed(2)}</strong></td></tr>`;
            message += `<tr><td style="padding: 5px 0; border-bottom: 1px solid #eee;">Tarjeta:</td><td style="padding: 5px 0; border-bottom: 1px solid #eee; text-align: right;"><strong>RD$${card.toFixed(2)}</strong></td></tr>`;
            message += `<tr><td style="padding: 5px 0; border-bottom: 1px solid #eee;">Transferencia:</td><td style="padding: 5px 0; border-bottom: 1px solid #eee; text-align: right;"><strong>RD$${transfer.toFixed(2)}</strong></td></tr>`;
            message += `<tr><td style="padding: 5px 0; border-bottom: 2px solid #ddd;">Total Real:</td><td style="padding: 5px 0; border-bottom: 2px solid #ddd; text-align: right;"><strong>RD$${(cash + card + transfer).toFixed(2)}</strong></td></tr>`;
            message += `<tr><td style="padding: 5px 0; border-bottom: 1px solid #eee;">Total Esperado:</td><td style="padding: 5px 0; border-bottom: 1px solid #eee; text-align: right;"><strong>RD$${expected.toFixed(2)}</strong></td></tr>`;
            message += `<tr><td style="padding: 5px 0;">Diferencia:</td><td style="padding: 5px 0; text-align: right;"><strong>${formatCurrency(Math.abs(difference))}</strong></td></tr>`;
            message += `</table>`;
            
            if (difference === 0) {
                message += `<div style="background: rgba(46, 204, 113, 0.1); padding: 8px; border-radius: 5px; margin-top: 10px; color: #27ae60;">
                    <i class='bx bx-check'></i> Perfecto, no hay diferencia
                </div>`;
            } else if (difference > 0) {
                message += `<div style="background: rgba(241, 196, 15, 0.1); padding: 8px; border-radius: 5px; margin-top: 10px; color: #f39c12;">
                    <i class='bx bx-up-arrow-alt'></i> Sobrante de ${formatCurrency(difference)}
                </div>`;
            } else {
                message += `<div style="background: rgba(231, 76, 60, 0.1); padding: 8px; border-radius: 5px; margin-top: 10px; color: #e74c3c;">
                    <i class='bx bx-down-arrow-alt'></i> Faltante de ${formatCurrency(Math.abs(difference))}
                </div>`;
            }

            // Verificar si es hora de cierre automático
            if (isAutoCloseTimeNow()) {
                message += `<br><div style="background: rgba(243, 156, 18, 0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12; margin-top: 10px;">
                    <i class='bx bx-time'></i> <strong>NOTA:</strong> Es después de las 5:30 PM.
                </div>`;
            }

            showAlert(
                'Confirmar cierre manual', 
                message,
                'question',
                function() {
                    // Mostrar loading
                    showLoading('Procesando cierre manual...', 'Por favor espere...');
                    
                    // Enviar el formulario después de 1 segundo
                    setTimeout(function() {
                        DOM.form.submit();
                    }, 1000);
                },
                function() {
                    // Si cancelan, reiniciar cuenta regresiva si es después de las 5:30
                    if (isAutoCloseTimeNow()) {
                        setTimeout(function() {
                            startAutoCloseCountdown();
                        }, 500);
                    }
                }
            );
        }

        // Función para forzar cierre automático inmediato (para testing)
        function forceAutoClose() {
            if (confirm("¿Forzar cierre automático inmediato? (Solo para pruebas)")) {
                executeAutoClose();
            }
        }

        // Event Listeners
        DOM.cashAmount.addEventListener("input", calculateDifference);
        DOM.cardAmount.addEventListener("input", calculateDifference);
        DOM.transferAmount.addEventListener("input", calculateDifference);
        DOM.customAlertOverlay.addEventListener("click", hideAlert);

        // Event listeners para detener cuenta regresiva si el usuario interactúa
        DOM.cashAmount.addEventListener("focus", stopAutoCloseCountdown);
        DOM.cardAmount.addEventListener("focus", stopAutoCloseCountdown);
        DOM.transferAmount.addEventListener("focus", stopAutoCloseCountdown);
        DOM.observations.addEventListener("focus", stopAutoCloseCountdown);
        DOM.closeRegisterBtn.addEventListener("click", stopAutoCloseCountdown);

        // Prevenir que el formulario se envíe automáticamente
        DOM.form.addEventListener('submit', function(e) {
            // Solo permitir envío si es manual (el cierre automático usa AJAX)
            if (autoCloseInProgress) {
                e.preventDefault();
                return false;
            }
            return true;
        });

        // Inicialización
        function init() {
            // Autocompletar con montos de ventas
            const sales = autoFillWithSales();
            
            // Iniciar y actualizar la hora cada segundo
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Verificar si es después de las 5:30 PM al cargar la página
            if (isAutoCloseTimeNow()) {
                isAutoCloseTime = true;
                
                // Verificar si ya hay una alerta crítica mostrada
                if (!DOM.autoCloseCritical) {
                    // Mostrar mensaje de cierre automático inmediato
                    setTimeout(function() {
                        showAutoCloseWarning();
                    }, 1500);
                } else {
                    // Si ya hay alerta crítica, iniciar cuenta regresiva directamente
                    setTimeout(function() {
                        startAutoCloseCountdown();
                    }, 2000);
                }
            } else if (sales.cashSales > 0 || sales.cardSales > 0 || sales.transferSales > 0) {
                // Mostrar alerta informativa si hay ventas
                setTimeout(function() {
                    showAlert(
                        'Monto Sugerido', 
                        `Se han autocompletado los montos con los totales de ventas:<br><br>
                        <table style="width:100%;">
                            <tr><td>Efectivo:</td><td style="text-align: right;"><strong>RD$${sales.cashSales.toFixed(2)}</strong></td></tr>
                            <tr><td>Tarjeta:</td><td style="text-align: right;"><strong>RD$${sales.cardSales.toFixed(2)}</strong></td></tr>
                            <tr><td>Transferencia:</td><td style="text-align: right;"><strong>RD$${sales.transferSales.toFixed(2)}</strong></td></tr>
                        </table><br>
                        Puede ajustarlos si es necesario.`, 
                        'info'
                    );
                }, 1000);
            }
            
            // Verificar periodicamente si es después de las 5:30 PM
            setInterval(function() {
                if (isAutoCloseTimeNow() && !isAutoCloseTime && !autoCloseInProgress) {
                    isAutoCloseTime = true;
                    if (!autoCloseCountdown) {
                        startAutoCloseCountdown();
                    }
                }
            }, 30000); // Verificar cada 30 segundos
            
            // Agregar botón de prueba para cierre automático (solo en desarrollo)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const testBtn = document.createElement('button');
                testBtn.innerHTML = '<i class="bx bx-test-tube"></i> Test Cierre Auto';
                testBtn.style.position = 'fixed';
                testBtn.style.bottom = '20px';
                testBtn.style.right = '20px';
                testBtn.style.zIndex = '1000';
                testBtn.style.padding = '10px 15px';
                testBtn.style.background = '#3498db';
                testBtn.style.color = 'white';
                testBtn.style.border = 'none';
                testBtn.style.borderRadius = '5px';
                testBtn.style.cursor = 'pointer';
                testBtn.style.fontSize = '12px';
                testBtn.onclick = forceAutoClose;
                document.body.appendChild(testBtn);
            }
        }

        // Inicializar todo cuando el DOM esté listo
        init();
        
        // Agregar al objeto window para debugging
        window.cierreCajaApp = {
            toggleSidebar,
            closeSidebar,
            showAlert,
            hideAlert,
            showLoading,
            hideLoading,
            autoFillWithSales,
            startAutoCloseCountdown,
            stopAutoCloseCountdown,
            executeAutoClose,
            confirmClose,
            forceAutoClose,
            isAutoCloseTimeNow,
            DOM
        };
    });
</script>
</body>
</html>